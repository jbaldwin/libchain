version: 2
jobs:
    build-ubuntu:
        docker:
            - image: ubuntu:rolling
        steps:
            - run:
                name: update
                command: apt-get -y update
            - run:
                name: install dependencies
                command: |
                    apt-get -y install \
                        git \
                        cmake \
                        ninja-build \
                        g++ \
                        clang
            - checkout
            - run:
                name: build release g++
                command: |
                    mkdir build-release-g++
                    cd build-release-g++
                    cmake \
                        -GNinja \
                        -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_C_COMPILER=gcc \
                        -DCMAKE_CXX_COMPILER=g++ \
                        ..
                    ninja
            - run:
                name: build release clang++
                command: |
                    mkdir build-release-clang++
                    cd build-release-clang++
                    cmake \
                        -GNinja \
                        -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_C_COMPILER=clang \
                        -DCMAKE_CXX_COMPILER=clang++ \
                        ..
                    ninja
            - run:
                name: test release g++
                command: |
                    cd build-release-g++
                    ctest -V
            - run:
                name: test release clang++
                command: |
                    cd build-release-clang++
                    ctest -V

    build-fedora:
        docker:
            - image: fedora:latest
        steps:
            - run:
                name: update
                command: dnf update -y
            - run:
                name: install dependencies
                command: |
                    dnf install -y \
                        git \
                        cmake \
                        ninja-build \
                        g++ \
                        clang
            - checkout
            - run:
                name: build release g++
                command: |
                    mkdir build-release-g++
                    cd build-release-g++
                    cmake \
                        -GNinja \
                        -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_C_COMPILER=gcc \
                        -DCMAKE_CXX_COMPILER=g++ \
                        ..
                    ninja
            - run:
                name: build release clang++
                command: |
                    mkdir build-release-clang++
                    cd build-release-clang++
                    cmake \
                        -GNinja \
                        -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_C_COMPILER=clang \
                        -DCMAKE_CXX_COMPILER=clang++ \
                        ..
                    ninja
            - run:
                name: test release g++
                command: |
                    cd build-release-g++
                    ctest -V
            - run:
                name: test release clang++
                command: |
                    cd build-release-clang++
                    ctest -V

workflows:
    version: 2
    build-test:
        jobs:
        - build-ubuntu
        # the OSS/free tier can't handle them all at once
        - build-fedora:
            requires:
                - build-ubuntu
